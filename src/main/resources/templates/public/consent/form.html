<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/public}" th:with="pageApartmentName=${apart.aptName}, pageConsentTitle=${template.title}">
  <head>
    <title th:text="${apart.aptName} + ' ' + ${template.title}">동의서 작성</title>

    <!--/* Additional CSS for this page */-->
    <th:block layout:fragment="css">
      <style>
        html {
          -webkit-text-size-adjust: 100%;
        }
        input[type="text"],
        input[type="tel"],
        textarea {
          font-size: 16px !important;
        }
        .signature-pad {
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          background: white;
          touch-action: none;
        }
      </style>
    </th:block>
  </head>
  <body>
    <!--/* Main Content */-->
    <div layout:fragment="content">
      <div class="min-h-screen pb-4 max-w-4xl mx-auto">
        <!--/* Progress Bar - Sticky at top */-->
        <div class="sticky top-0 z-40 bg-white px-4 py-3 shadow-md border-b border-gray-200">
          <div class="relative w-full">
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="progressBar" class="bg-gray-600 h-3 rounded-full transition-all duration-300 relative" style="width: 0%">
                <span id="progressText" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-bold text-white">0%</span>
              </div>
            </div>
          </div>
        </div>

        <!--/* Form */-->
        <form id="consentForm" class="p-4 pt-12 space-y-8 bg-white" th:action="@{/consent/{apartCode}/{templateId}/submit(apartCode=${apartCode},templateId=${templateId})}" method="post">
          <!--/* CSRF Token */-->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <!--/* Error Messages */-->
          <div th:if="${error}" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
              <p class="text-red-800 text-sm" th:text="${error}"></p>
            </div>
          </div>

          <!--/* 1. 동의서 내용 */-->
          <div>
            <h2 class="mb-2 flex items-center">1. 내용</h2>
            <!-- max-h-60 overflow-y-auto  -->
            <div id="templateContent" class="bg-gray-50 p-2 rounded-lg text-sm" th:data-original-content="${template.content}" th:data-apartment-name="${apart.aptName}">
              <div th:utext="${template.content}">동의서 내용이 여기에 표시됩니다.</div>
            </div>
          </div>

          <!--/* 2. 인적 사항 */-->
          <div>
            <h2 class="mb-2 flex items-center">2. 인적 사항</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  이름
                  <span class="text-red-500">*</span>
                </label>
                <input type="text" name="representativeName" th:field="*{submission.representativeName}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="홍길동" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  연락처
                  <span class="text-red-500">*</span>
                </label>
                <input type="tel" name="representativePhone" th:field="*{submission.representativePhone}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="01012345678" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">생년월일 (YYYYMMDD)</label>
                <input type="text" name="representativeBirth" th:field="*{submission.representativeBirth}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="19900101" maxlength="8" pattern="[0-9]{8}" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    동
                    <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="building" th:field="*{submission.building}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="101" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    호
                    <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="unit" th:field="*{submission.unit}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="1501" required />
                </div>
              </div>
              <!--/* <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">비상연락처</label>
                <input type="tel" name="emergencyContact" th:field="*{submission.emergencyContact}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="01087654321" />
              </div> */-->
            </div>
          </div>

          <!--/* 4. 추가 가족 정보 */-->
          <!-- <div>
            <h2 class="mb-2 flex items-center">추가 가족 정보 (선택)</h2>
            <div id="additionalPersons" class="space-y-3">
            </div>
            <button type="button" onclick="addPerson()" class="w-full py-1 border-2 border-dashed border-gray-300 rounded-sm text-gray-600 hover:border-blue-500 hover:text-blue-500">
              <i class="fas fa-plus mr-2"></i>
              가족 추가
            </button>
          </div>
          -->

          <!--/* 5. 현재 주소 */-->
          <!-- <h2 class="mb-2 flex items-center">현재 거주지 주소</h2>
          <div class="space-y-3">
            <button type="button" onclick="searchAddress()" class="w-full py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
              <i class="fas fa-search mr-2"></i>
              주소 검색
            </button>
            <input type="text" name="currentAddress" id="currentAddress" th:field="*{submission.currentAddress}" class="w-full px-3 py-1 bg-orange-300 rounded-sm" placeholder="주소를 검색해주세요" readonly />
          </div> -->

          <!--/* 6. 개인정보 동의 */-->
          <div>
            <h2 class="mb-2 flex items-center">개인정보 수집·이용 동의</h2>
            <div class="space-y-3">
              <label class="flex items-start">
                <input type="checkbox" name="privacyAgreement" value="true" class="mt-1 mr-3 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" required />
                <span class="text-sm text-gray-700">
                  <strong class="text-red-500">[필수]</strong>
                  개인정보 수집·이용에 동의합니다.
                </span>
              </label>
              <label class="flex items-start">
                <input type="checkbox" name="marketingAgreement" value="true" class="mt-1 mr-3 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                <span class="text-sm text-gray-700">
                  <strong>[선택]</strong>
                  마케팅 정보 수신에 동의합니다.
                </span>
              </label>
            </div>
          </div>

          <!--/* 7. 서명 */-->
          <div>
            <h2 class="mb-2 flex items-center">서명</h2>
            <div class="space-y-3 px-4">
              <canvas id="signaturePad" class="signature-pad w-full" height="200"></canvas>
              <input type="hidden" name="signatureData" id="signatureData" />

              <div class="flex space-x-2">
                <button type="button" onclick="clearSignature()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                  <i class="fas fa-eraser mr-2"></i>
                  지우기
                </button>
              </div>
            </div>
          </div>

          <!--/* Submit Button */-->
          <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
            <i class="fas fa-check mr-2"></i>
            동의서 제출
          </button>
        </form>
      </div>
    </div>

    <!--/* Page-specific Scripts */-->
    <th:block layout:fragment="script">
      <!--/* Daum 주소 API */-->
      <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

      <!--/* JavaScript */-->
      <script>
        let personCount = 0;
        let signaturePad;
        let isDrawing = false;

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function () {
          initSignaturePad();
          updateProgress();
          replaceTemplateVariables();

          // Add input event listeners for progress update
          document.querySelectorAll("input, textarea").forEach((input) => {
            input.addEventListener("input", updateProgress);
            input.addEventListener("change", updateProgress);
          });
        });

        // Replace template variables with actual values
        function replaceTemplateVariables() {
          const contentDiv = document.getElementById("templateContent");
          if (!contentDiv) return;

          const apartmentName = contentDiv.dataset.apartmentName;
          const originalContent = contentDiv.dataset.originalContent;

          if (originalContent && apartmentName) {
            // {아파트명}을 실제 아파트명으로 치환
            let replacedContent = originalContent.replace(/{apartName}/g, '<span class="font-semibold">' + apartmentName + "</span>");

            // 동, 호, 이름 변수는 그대로 유지 (나중에 사용자 입력으로 대체될 예정)
            // 하지만 시각적으로 구분되도록 스타일 적용
            // replacedContent = replacedContent.replace(/{동}/g, '<span class="text-gray-400">[동]</span>');
            // replacedContent = replacedContent.replace(/{호}/g, '<span class="text-gray-400">[호]</span>');
            // replacedContent = replacedContent.replace(/{이름}/g, '<span class="text-gray-400">[이름]</span>');

            // 내용 업데이트
            contentDiv.innerHTML = "<div>" + replacedContent + "</div>";
          }
        }

        // Progress calculation
        function updateProgress() {
          const required = document.querySelectorAll("[required]");
          let filled = 0;

          required.forEach((field) => {
            if (field.type === "checkbox") {
              if (field.checked) filled++;
            } else if (field.value.trim()) {
              filled++;
            }
          });

          const progress = Math.round((filled / required.length) * 100);
          document.getElementById("progressBar").style.width = progress + "%";
          document.getElementById("progressText").textContent = progress + "%";
        }

        // Add family member
        function addPerson() {
          if (personCount >= 3) {
            alert("최대 3명까지 추가 가능합니다.");
            return;
          }

          personCount++;
          const container = document.getElementById("additionalPersons");
          const personDiv = document.createElement("div");
          personDiv.className = "p-3 bg-gray-50 rounded-lg space-y-2";
          personDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-sm">가족 ${personCount}</span>
                    <button type="button" onclick="removePerson(this)" class="text-red-500 text-sm">
                        <i class="fas fa-times"></i> 삭제
                    </button>
                </div>
                <input type="text" name="additionalPersons[${personCount - 1}].name"
                       class="w-full px-3 py-1 border border-gray-300 rounded-sm"
                       placeholder="이름">
                <input type="text" name="additionalPersons[${personCount - 1}].birthDate"
                       class="w-full px-3 py-1 border border-gray-300 rounded-sm"
                       placeholder="생년월일 (YYYYMMDD)" maxlength="8">
                <input type="tel" name="additionalPersons[${personCount - 1}].phoneNumber"
                       class="w-full px-3 py-1 border border-gray-300 rounded-sm"
                       placeholder="연락처">
                <input type="text" name="additionalPersons[${personCount - 1}].relation"
                       class="w-full px-3 py-1 border border-gray-300 rounded-sm"
                       placeholder="관계 (예: 배우자, 자녀)">
            `;
          container.appendChild(personDiv);
        }

        // Remove family member
        function removePerson(button) {
          button.closest(".p-3").remove();
          personCount--;
          // Re-index remaining persons
          const persons = document.querySelectorAll("#additionalPersons > div");
          persons.forEach((div, index) => {
            div.querySelectorAll("input").forEach((input) => {
              const name = input.name.replace(/\[\d+\]/, `[${index}]`);
              input.name = name;
            });
            div.querySelector(".font-medium").textContent = `가족 ${index + 1}`;
          });
        }

        // Address search using Daum API
        function searchAddress() {
          new daum.Postcode({
            oncomplete: function (data) {
              let fullAddress = data.address;
              if (data.addressType === "R") {
                if (data.bname !== "") {
                  fullAddress += " (" + data.bname + ")";
                }
                if (data.buildingName !== "") {
                  fullAddress += ", " + data.buildingName;
                }
              }
              document.getElementById("currentAddress").value = fullAddress;
              updateProgress();
            },
          }).open();
        }

        // Signature pad initialization
        function initSignaturePad() {
          const canvas = document.getElementById("signaturePad");
          const ctx = canvas.getContext("2d");

          // Set canvas size
          canvas.width = canvas.offsetWidth;

          // Mouse events
          canvas.addEventListener("mousedown", startDrawing);
          canvas.addEventListener("mousemove", draw);
          canvas.addEventListener("mouseup", stopDrawing);
          canvas.addEventListener("mouseout", stopDrawing);

          // Touch events
          canvas.addEventListener("touchstart", handleTouch);
          canvas.addEventListener("touchmove", handleTouch);
          canvas.addEventListener("touchend", stopDrawing);

          signaturePad = {
            canvas: canvas,
            ctx: ctx,
            lastX: 0,
            lastY: 0,
          };
        }

        function startDrawing(e) {
          isDrawing = true;
          const rect = signaturePad.canvas.getBoundingClientRect();
          signaturePad.lastX = e.clientX - rect.left;
          signaturePad.lastY = e.clientY - rect.top;
        }

        function draw(e) {
          if (!isDrawing) return;

          const rect = signaturePad.canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          signaturePad.ctx.beginPath();
          signaturePad.ctx.moveTo(signaturePad.lastX, signaturePad.lastY);
          signaturePad.ctx.lineTo(x, y);
          signaturePad.ctx.strokeStyle = "#000";
          signaturePad.ctx.lineWidth = 2;
          signaturePad.ctx.stroke();

          signaturePad.lastX = x;
          signaturePad.lastY = y;
        }

        function handleTouch(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent(e.type === "touchstart" ? "mousedown" : e.type === "touchmove" ? "mousemove" : "mouseup", {
            clientX: touch.clientX,
            clientY: touch.clientY,
          });
          signaturePad.canvas.dispatchEvent(mouseEvent);
        }

        function stopDrawing() {
          if (isDrawing) {
            isDrawing = false;
            // Save signature as base64
            document.getElementById("signatureData").value = signaturePad.canvas.toDataURL();
          }
        }

        function clearSignature() {
          const ctx = signaturePad.ctx;
          ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
          document.getElementById("signatureData").value = "";
        }

        // Form submission
        document.getElementById("consentForm").addEventListener("submit", function (e) {
          const signatureData = document.getElementById("signatureData").value;
          if (!signatureData) {
            e.preventDefault();
            alert("서명을 해주세요.");
            return false;
          }
        });
      </script>
    </th:block>
  </body>
</html>

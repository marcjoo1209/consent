<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/default}">
<head>
    <title>동의서 관리</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">동의서 관리</h1>
                <p class="text-gray-600">제출된 동의서를 조회하고 관리합니다.</p>
            </div>

            <!-- Search Card Component -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4">검색 조건</h3>
                <form th:action="@{/admin/consent}" method="get">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Apartment Select -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">아파트</label>
                            <select name="apartmentId" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">전체</option>
                                <!-- Dynamic options will be added -->
                            </select>
                        </div>

                        <!-- Dong Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">동</label>
                            <input type="text" name="dong" th:value="${searchRequest.dong}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="예: 101">
                        </div>

                        <!-- Ho Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">호수</label>
                            <input type="text" name="ho" th:value="${searchRequest.ho}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="예: 1501">
                        </div>

                        <!-- Status Select -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">상태</label>
                            <select name="status" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">전체</option>
                                <option th:each="status : ${statuses}"
                                        th:value="${status}"
                                        th:text="${status.description}"
                                        th:selected="${searchRequest.status == status}"></option>
                            </select>
                        </div>

                        <!-- Participant Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">신청자명</label>
                            <input type="text" name="participantName" th:value="${searchRequest.participantName}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="이름 검색">
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">전화번호</label>
                            <input type="text" name="phoneNumber" th:value="${searchRequest.phoneNumber}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="010-XXXX-XXXX">
                        </div>

                        <!-- Start Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">시작일</label>
                            <input type="date" name="startDate" th:value="${searchRequest.startDate}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <!-- End Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">종료일</label>
                            <input type="date" name="endDate" th:value="${searchRequest.endDate}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-2 mt-6">
                        <a href="/admin/consent" 
                           class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-redo mr-2"></i>초기화
                        </a>
                        <button type="button" onclick="ConsentApp.exportExcel()" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-file-excel mr-2"></i>Excel 다운로드
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-search mr-2"></i>검색
                        </button>
                    </div>
                </form>
            </div>

            <!-- Bulk Actions & Statistics -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <button onclick="ConsentApp.bulkApprove()" 
                            id="bulkApproveBtn"
                            disabled
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <i class="fas fa-check-circle mr-2"></i>선택 승인
                    </button>
                    <button onclick="ConsentApp.bulkReject()" 
                            id="bulkRejectBtn"
                            disabled
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <i class="fas fa-times-circle mr-2"></i>선택 반려
                    </button>
                </div>
                <div class="text-gray-600">
                    총 <span th:text="${page.totalElements}" class="font-bold text-gray-900">0</span>건
                </div>
            </div>

            <!-- Table Card Component -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-center">
                                    <input type="checkbox" id="selectAll" 
                                           onchange="ConsentApp.toggleSelectAll()"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">번호</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">아파트</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">동/호</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">신청자</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">전화번호</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">신청일</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="consent : ${consents}" class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" name="consentIds" 
                                           th:value="${consent.id}"
                                           onchange="ConsentApp.updateBulkButtons()"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900" th:text="${consent.id}"></td>
                                <td class="px-6 py-4 text-sm text-gray-900" th:text="${consent.apart?.aptName}"></td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    <span th:text="${consent.aptDong + '동 ' + consent.aptHo + '호'}"></span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900" 
                                    th:text="${consent.persons?.size() > 0 ? consent.persons[0].name : '-'}"></td>
                                <td class="px-6 py-4 text-sm text-gray-900"
                                    th:text="${consent.persons?.size() > 0 ? consent.persons[0].phoneNumber : '-'}"></td>
                                <td class="px-6 py-4">
                                    <span th:class="${'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + 
                                                    (consent.status.name() == 'PENDING' ? 'bg-yellow-100 text-yellow-800' : 
                                                     consent.status.name() == 'APPROVED' ? 'bg-green-100 text-green-800' : 
                                                     consent.status.name() == 'REJECTED' ? 'bg-red-100 text-red-800' : 
                                                     'bg-gray-100 text-gray-800')}"
                                          th:text="${consent.status.description}"></span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900" 
                                    th:text="${#temporals.format(consent.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                                <td class="px-6 py-4 text-sm">
                                    <div class="flex gap-2">
                                        <a th:href="@{/admin/consent/{id}(id=${consent.id})}" 
                                           class="text-blue-600 hover:text-blue-900 transition"
                                           title="상세보기">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button th:if="${consent.status.name() == 'PENDING' or consent.status.name() == 'SUBMITTED'}"
                                                th:onclick="'ConsentApp.approveConsent(' + ${consent.id} + ')'"
                                                class="text-green-600 hover:text-green-900 transition"
                                                title="승인">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button th:if="${consent.status.name() == 'PENDING' or consent.status.name() == 'SUBMITTED'}"
                                                th:onclick="'ConsentApp.rejectConsent(' + ${consent.id} + ')'"
                                                class="text-red-600 hover:text-red-900 transition"
                                                title="반려">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Empty State -->
                            <tr th:if="${#lists.isEmpty(consents)}">
                                <td colspan="9" class="px-6 py-12 text-center">
                                    <div class="text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-4"></i>
                                        <p class="text-lg">조회된 동의서가 없습니다.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination Component -->
            <div th:if="${page.totalPages > 1}" class="mt-6 flex justify-center">
                <nav class="flex items-center gap-1">
                    <!-- Previous Button -->
                    <a th:if="${page.hasPrevious()}"
                       th:href="@{/admin/consent(page=${page.number - 1}, size=${page.size})}"
                       class="px-3 py-2 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 transition">
                        <i class="fas fa-chevron-left"></i>
                    </a>

                    <!-- Page Numbers -->
                    <th:block th:each="pageNum : ${#numbers.sequence(0, page.totalPages - 1)}">
                        <a th:href="@{/admin/consent(page=${pageNum}, size=${page.size})}"
                           th:text="${pageNum + 1}"
                           th:class="${pageNum == page.number ? 
                                      'px-4 py-2 bg-blue-600 text-white rounded-lg' : 
                                      'px-4 py-2 bg-white border border-gray-300 hover:bg-gray-100 transition'}"></a>
                    </th:block>

                    <!-- Next Button -->
                    <a th:if="${page.hasNext()}"
                       th:href="@{/admin/consent(page=${page.number + 1}, size=${page.size})}"
                       class="px-3 py-2 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 transition">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>
            </div>
        </div>
    </div>

    <!-- Page Specific Scripts -->
    <th:block layout:fragment="script">
        <script type="module">
            // Extend ConsentApp with page-specific functions
            window.ConsentApp = window.ConsentApp || {};
            
            ConsentApp.toggleSelectAll = function() {
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.getElementsByName('consentIds');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
                ConsentApp.updateBulkButtons();
            };
            
            ConsentApp.updateBulkButtons = function() {
                const checkboxes = document.getElementsByName('consentIds');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                document.getElementById('bulkApproveBtn').disabled = checkedCount === 0;
                document.getElementById('bulkRejectBtn').disabled = checkedCount === 0;
            };
            
            ConsentApp.bulkApprove = function() {
                const checkboxes = document.getElementsByName('consentIds');
                const ids = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (ids.length === 0) return;
                
                if (confirm(`선택한 ${ids.length}건의 동의서를 승인하시겠습니까?`)) {
                    fetch('/admin/consent/bulk-approve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(ids)
                    })
                    .then(response => response.json())
                    .then(data => {
                        ConsentApp.showToast(data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    })
                    .catch(error => {
                        ConsentApp.showToast('처리 중 오류가 발생했습니다.', 'error');
                    });
                }
            };
            
            ConsentApp.bulkReject = function() {
                const checkboxes = document.getElementsByName('consentIds');
                const ids = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (ids.length === 0) return;
                
                const reason = prompt('반려 사유를 입력하세요:');
                if (reason) {
                    fetch('/admin/consent/bulk-reject?reason=' + encodeURIComponent(reason), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(ids)
                    })
                    .then(response => response.json())
                    .then(data => {
                        ConsentApp.showToast(data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    })
                    .catch(error => {
                        ConsentApp.showToast('처리 중 오류가 발생했습니다.', 'error');
                    });
                }
            };
            
            ConsentApp.approveConsent = function(id) {
                if (confirm('이 동의서를 승인하시겠습니까?')) {
                    fetch(`/admin/consent/${id}/approve`, {method: 'POST'})
                        .then(response => response.json())
                        .then(data => {
                            ConsentApp.showToast(data.message, 'success');
                            setTimeout(() => location.reload(), 1500);
                        })
                        .catch(error => {
                            ConsentApp.showToast('처리 중 오류가 발생했습니다.', 'error');
                        });
                }
            };
            
            ConsentApp.rejectConsent = function(id) {
                const reason = prompt('반려 사유를 입력하세요:');
                if (reason) {
                    fetch(`/admin/consent/${id}/reject?reason=` + encodeURIComponent(reason), {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        ConsentApp.showToast(data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    })
                    .catch(error => {
                        ConsentApp.showToast('처리 중 오류가 발생했습니다.', 'error');
                    });
                }
            };
            
            ConsentApp.exportExcel = function() {
                const params = new URLSearchParams(window.location.search);
                window.location.href = '/admin/consent/export?' + params.toString();
            };
        </script>
    </th:block>
</body>
</html>
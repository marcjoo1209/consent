<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}">
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!--/* Page Header */-->
        <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h1 class="text-4xl font-bold text-gray-900">동의서 상세</h1>
            <p class="mt-2 text-gray-600">
              동의서 번호:
              <span class="font-semibold text-gray-900">
                #
                <span th:text="${consent.id}"></span>
              </span>
            </p>
          </div>
          <a th:href="@{/admin/consent}" class="inline-flex items-center px-5 py-2.5 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition duration-200 shadow-sm">
            <i class="fas fa-arrow-left mr-2"></i>
            목록으로
          </a>
        </div>

        <!--/* Basic Info Card (Using card component style) */-->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-200">기본 정보</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">아파트</label>
              <p class="text-gray-900" th:text="${consent.apartmentName}"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">동/호</label>
              <p class="text-gray-900" th:text="${consent.dong + '동 ' + consent.ho + '호'}"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">상태</label>
              <span
                th:class="${'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' + 
                          (consent.status.name() == 'PENDING' ? 'bg-yellow-100 text-yellow-800' : 
                           consent.status.name() == 'APPROVED' ? 'bg-green-100 text-green-800' : 
                           consent.status.name() == 'REJECTED' ? 'bg-red-100 text-red-800' : 
                           'bg-gray-100 text-gray-800')}"
                th:text="${consent.status.description}"
              ></span>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">신청일시</label>
              <p class="text-gray-900" th:text="${#temporals.format(consent.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></p>
            </div>
            <div th:if="${consent.approvedAt != null}">
              <label class="block text-sm font-medium text-gray-700 mb-1">승인일시</label>
              <p class="text-gray-900" th:text="${#temporals.format(consent.approvedAt, 'yyyy-MM-dd HH:mm:ss')}"></p>
            </div>
            <div th:if="${consent.rejectedAt != null}">
              <label class="block text-sm font-medium text-gray-700 mb-1">반려일시</label>
              <p class="text-gray-900" th:text="${#temporals.format(consent.rejectedAt, 'yyyy-MM-dd HH:mm:ss')}"></p>
            </div>
          </div>

          <!--/* Alert-style notification for approval comment */-->
          <div th:if="${consent.approvalComment != null}" class="mt-4">
            <div class="bg-green-50 border-l-4 border-green-500 p-4">
              <div class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                <div>
                  <p class="text-green-800 font-medium">승인 코멘트</p>
                  <p class="text-green-700 text-sm mt-1" th:text="${consent.approvalComment}"></p>
                </div>
              </div>
            </div>
          </div>

          <!--/* Alert-style notification for rejection reason */-->
          <div th:if="${consent.rejectionReason != null}" class="mt-4">
            <div class="bg-red-50 border-l-4 border-red-500 p-4">
              <div class="flex items-start">
                <i class="fas fa-times-circle text-red-500 mr-3 mt-1"></i>
                <div>
                  <p class="text-red-800 font-medium">반려 사유</p>
                  <p class="text-red-700 text-sm mt-1" th:text="${consent.rejectionReason}"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!--/* Participants Card */-->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-200">참여자 정보</h3>
          <div class="space-y-4">
            <div th:each="participant, stat : ${consent.participants}" class="border border-gray-200 rounded-lg p-5 hover:shadow-sm transition duration-200">
              <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg text-gray-900">
                  참여자
                  <span th:text="${stat.count}"></span>
                </h3>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full" th:text="${participant.relation}"></span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                  <p class="text-gray-900" th:text="${participant.name}"></p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">생년월일</label>
                  <p class="text-gray-900" th:text="${participant.birthDate}"></p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">전화번호</label>
                  <p class="text-gray-900" th:text="${participant.phoneNumber}"></p>
                </div>
              </div>

              <!--/* 서명 이미지 */-->
              <div th:if="${participant.signatureUrl != null}" class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">서명</label>
                <div class="border rounded p-4 bg-gray-50">
                  <img th:src="${participant.signatureUrl}" alt="서명" class="max-h-32" />
                </div>
              </div>
            </div>

            <div th:if="${#lists.isEmpty(consent.participants)}" class="text-center py-12">
              <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                  <i class="fas fa-users text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500">참여자 정보가 없습니다.</p>
              </div>
            </div>
          </div>
        </div>

        <!--/* Attachments Card */-->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-200">첨부파일</h3>
          <div class="space-y-2">
            <div th:each="attachment : ${consent.attachments}" class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
              <div class="flex items-center">
                <i class="fas fa-file mr-3 text-gray-400"></i>
                <div>
                  <p class="font-medium" th:text="${attachment.fileName}"></p>
                  <p class="text-sm text-gray-500">
                    <span th:text="${attachment.fileType}"></span>
                    •
                    <span th:text="${#numbers.formatDecimal(attachment.fileSize / 1024.0 / 1024.0, 1, 2) + ' MB'}"></span>
                  </p>
                </div>
              </div>
              <a th:href="${attachment.downloadUrl}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-download mr-2"></i>
                다운로드
              </a>
            </div>

            <div th:if="${#lists.isEmpty(consent.attachments)}" class="text-center py-12">
              <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                  <i class="fas fa-folder-open text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500">첨부파일이 없습니다.</p>
              </div>
            </div>
          </div>
        </div>

        <!--/* Action Buttons Card */-->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex flex-wrap justify-end gap-3">
            <button th:if="${consent.status.name() == 'PENDING' or consent.status.name() == 'SUBMITTED'}" onclick="ConsentDetail.approve()" class="inline-flex items-center px-6 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-200 shadow-sm">
              <i class="fas fa-check-circle mr-2"></i>
              동의서 승인
            </button>
            <button th:if="${consent.status.name() == 'PENDING' or consent.status.name() == 'SUBMITTED'}" onclick="ConsentDetail.reject()" class="inline-flex items-center px-6 py-2.5 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-200 shadow-sm">
              <i class="fas fa-times-circle mr-2"></i>
              동의서 반려
            </button>
            <button onclick="window.print()" class="inline-flex items-center px-6 py-2.5 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition duration-200 shadow-sm">
              <i class="fas fa-print mr-2"></i>
              인쇄하기
            </button>
          </div>
        </div>
      </div>
    </div>

    <!--/* Page-specific scripts */-->
    <th:block layout:fragment="script">
      <script th:inline="javascript">
        /*<![CDATA[*/
        const consentId = /*[[${consent.id}]]*/ [];
        const ConsentDetail = {
          approve: function () {
            const comment = prompt("승인 코멘트를 입력하세요 (선택사항):");

            let url = `/admin/consent/${consentId}/approve`;
            if (comment) {
              url += `?comment=${encodeURIComponent(comment)}`;
            }

            fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (window.ConsentApp && window.ConsentApp.showToast) {
                  window.ConsentApp.showToast(data.message, "success");
                } else {
                  showToast(data.message, "success");
                }
                setTimeout(() => location.reload(), 1500);
              })
              .catch((error) => {
                if (window.ConsentApp && window.ConsentApp.showToast) {
                  window.ConsentApp.showToast("승인 처리 중 오류가 발생했습니다.", "error");
                } else {
                  showToast("승인 처리 중 오류가 발생했습니다.", "error");
                }
                console.error("Approval error:", error);
              });
          },

          reject: function () {
            const reason = prompt("반려 사유를 입력하세요:");
            if (!reason) {
              if (window.ConsentApp && window.ConsentApp.showToast) {
                window.ConsentApp.showToast("반려 사유는 필수입니다.", "warning");
              } else {
                showToast("반려 사유는 필수입니다.", "warning");
              }
              return;
            }

            fetch(`/admin/consent/${consentId}/reject?reason=${encodeURIComponent(reason)}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (window.ConsentApp && window.ConsentApp.showToast) {
                  window.ConsentApp.showToast(data.message, "success");
                } else {
                  showToast(data.message, "success");
                }
                setTimeout(() => location.reload(), 1500);
              })
              .catch((error) => {
                if (window.ConsentApp && window.ConsentApp.showToast) {
                  window.ConsentApp.showToast("반려 처리 중 오류가 발생했습니다.", "error");
                } else {
                  showToast("반려 처리 중 오류가 발생했습니다.", "error");
                }
                console.error("Rejection error:", error);
              });
          },
        };
        /*]]>*/
      </script>
    </th:block>
  </body>
</html>

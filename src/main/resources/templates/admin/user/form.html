<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}">
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!--/* Page Header */-->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900" th:text="${user.id != null ? '사용자 수정' : '새 사용자 등록'}">사용자 관리</h1>
          <p class="mt-2 text-gray-600">사용자 정보를 입력하여 관리자 계정을 생성하거나 수정합니다</p>
        </div>

        <!--/* Form Card */-->
        <div class="bg-white rounded-lg shadow-md p-6">
          <form th:action="${user.id != null ? '/admin/users/' + user.id : '/admin/users'}" th:object="${user}" method="post" novalidate>
            <!--/* Global Errors */-->
            <div th:if="${#fields.hasGlobalErrors()}" class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                <div>
                  <p class="text-red-800 font-medium">오류가 발생했습니다</p>
                  <ul class="text-red-700 text-sm mt-1 list-disc list-inside">
                    <li th:each="error : ${#fields.globalErrors()}" th:text="${error}"></li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!--/* 사용자명 */-->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  사용자명
                  <span class="text-red-500">*</span>
                </label>
                <input type="text" th:field="*{username}" th:classappend="${#fields.hasErrors('username')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" placeholder="로그인에 사용할 사용자명을 입력하세요" />
                <p th:if="${#fields.hasErrors('username')}" class="mt-1 text-sm text-red-600" th:errors="*{username}"></p>
              </div>

              <!--/* 이름 */-->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  이름
                  <span class="text-red-500">*</span>
                </label>
                <input type="text" th:field="*{name}" th:classappend="${#fields.hasErrors('name')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" placeholder="실명을 입력하세요" />
                <p th:if="${#fields.hasErrors('name')}" class="mt-1 text-sm text-red-600" th:errors="*{name}"></p>
              </div>

              <!--/* 이메일 */-->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  이메일
                  <span class="text-red-500">*</span>
                </label>
                <input type="email" th:field="*{email}" th:classappend="${#fields.hasErrors('email')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" placeholder="example@company.com" />
                <p th:if="${#fields.hasErrors('email')}" class="mt-1 text-sm text-red-600" th:errors="*{email}"></p>
              </div>

              <!--/* 전화번호 */-->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">전화번호</label>
                <input type="tel" th:field="*{phoneNumber}" th:classappend="${#fields.hasErrors('phoneNumber')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" placeholder="010-1234-5678" />
                <p th:if="${#fields.hasErrors('phoneNumber')}" class="mt-1 text-sm text-red-600" th:errors="*{phoneNumber}"></p>
              </div>

              <!--/* 권한 */-->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  권한
                  <span class="text-red-500">*</span>
                </label>
                <select th:field="*{role}" th:classappend="${#fields.hasErrors('role')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50">
                  <option value="">권한을 선택하세요</option>
                  <option th:each="roleOption : ${roles}" th:value="${roleOption}" th:text="${roleOption == 'SUPER_ADMIN' ? '최고 관리자' : '관리자'}" th:selected="${roleOption == user.role}"></option>
                </select>
                <p th:if="${#fields.hasErrors('role')}" class="mt-1 text-sm text-red-600" th:errors="*{role}"></p>
              </div>

              <!--/* 상태 (수정시에만) */-->
              <div th:if="${user.id != null}">
                <label class="block text-sm font-medium text-gray-700 mb-1">상태</label>
                <div class="flex items-center">
                  <input type="checkbox" th:field="*{active}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                  <label class="ml-2 text-sm text-gray-700">활성 상태</label>
                </div>
              </div>
            </div>

            <!--/* Password Section */-->
            <div class="mt-6 border-t pt-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">
                <span th:if="${user.id == null}">비밀번호 설정</span>
                <span th:if="${user.id != null}">비밀번호 변경 (변경하지 않으려면 비워두세요)</span>
              </h3>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!--/* 비밀번호 */-->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span th:if="${user.id == null}">
                      비밀번호
                      <span class="text-red-500">*</span>
                    </span>
                    <span th:if="${user.id != null}">새 비밀번호</span>
                  </label>
                  <input type="password" th:field="*{password}" th:classappend="${#fields.hasErrors('password')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" th:placeholder="${user.id == null ? '8자 이상의 비밀번호를 입력하세요' : '새 비밀번호 (변경하지 않으려면 비워두세요)'}" />
                  <p th:if="${#fields.hasErrors('password')}" class="mt-1 text-sm text-red-600" th:errors="*{password}"></p>
                  <p class="mt-1 text-sm text-gray-500">최소 8자 이상, 영문+숫자+특수문자 조합 권장</p>
                </div>

                <!--/* 비밀번호 확인 */-->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span th:if="${user.id == null}">
                      비밀번호 확인
                      <span class="text-red-500">*</span>
                    </span>
                    <span th:if="${user.id != null}">새 비밀번호 확인</span>
                  </label>
                  <input type="password" th:field="*{confirmPassword}" th:classappend="${#fields.hasErrors('confirmPassword')} ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500'" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-opacity-50" th:placeholder="${user.id == null ? '비밀번호를 다시 입력하세요' : '새 비밀번호 확인'}" />
                  <p th:if="${#fields.hasErrors('confirmPassword')}" class="mt-1 text-sm text-red-600" th:errors="*{confirmPassword}"></p>
                </div>
              </div>
            </div>

            <!--/* Action Buttons */-->
            <div class="mt-8 flex justify-end space-x-3">
              <a th:href="@{/admin/users}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition">
                <i class="fas fa-times mr-2"></i>
                취소
              </a>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-save mr-2"></i>
                <span th:text="${user.id != null ? '수정' : '등록'}">저장</span>
              </button>
            </div>
          </form>
        </div>

        <!--/* Help Text */-->
        <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
            <div>
              <p class="text-blue-800 font-medium">안내사항</p>
              <ul class="text-blue-700 text-sm mt-1 space-y-1">
                <li>• 사용자명은 로그인 시 사용되며, 영문+숫자 조합을 권장합니다</li>
                <li>• 최고 관리자는 모든 기능에 접근할 수 있습니다</li>
                <li>• 관리자는 제한된 관리 기능만 사용할 수 있습니다</li>
                <li th:if="${user.id != null}">• 비밀번호 변경이 필요하지 않은 경우 비밀번호 필드를 비워두세요</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--/* Page-specific scripts */-->
    <th:block layout:fragment="script">
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const passwordField = document.querySelector('input[name="password"]');
          const confirmPasswordField = document.querySelector('input[name="confirmPassword"]');

          if (confirmPasswordField) {
            confirmPasswordField.addEventListener("blur", function () {
              if (passwordField.value && confirmPasswordField.value && passwordField.value !== confirmPasswordField.value) {
                confirmPasswordField.setCustomValidity("비밀번호가 일치하지 않습니다");
              } else {
                confirmPasswordField.setCustomValidity("");
              }
            });
          }

          // Phone number formatting
          const phoneField = document.querySelector('input[name="phoneNumber"]');
          if (phoneField) {
            phoneField.addEventListener("input", function (e) {
              let value = e.target.value.replace(/[^0-9]/g, "");
              if (value.length <= 11) {
                if (value.length > 6) {
                  value = value.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
                } else if (value.length > 3) {
                  value = value.replace(/(\d{3})(\d+)/, "$1-$2");
                }
              }
              e.target.value = value;
            });
          }
        });
      </script>
    </th:block>
  </body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}">
  <body>
    <div layout:fragment="content">
      <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!--/* Page Header */-->
        <div class="mb-8">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900" th:text="${templateId != null ? '동의서 템플릿 수정' : '동의서 템플릿 생성'}">동의서 템플릿</h1>
              <p class="mt-2 text-gray-600">동의서 템플릿을 생성하거나 수정합니다.</p>
            </div>
            <a href="/admin/templates" class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
              <i class="fas fa-arrow-left mr-2"></i>
              목록으로
            </a>
          </div>
        </div>

        <!--/* Error/Success Messages */-->
        <div th:if="${errorMessage}" class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
            <p class="text-red-800" th:text="${errorMessage}">오류 메시지</p>
          </div>
        </div>

        <div th:if="${successMessage}" class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <p class="text-green-800" th:text="${successMessage}">성공 메시지</p>
          </div>
        </div>

        <!--/* Template Form */-->
        <div class="bg-white rounded-lg shadow-md p-4">
          <form th:action="${templateId != null ? '/admin/templates/' + templateId + '/edit' : '/admin/templates/new'}" th:object="${template}" method="post" class="space-y-6">
            <!--/* Title Field */-->
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                템플릿 제목
                <span class="text-red-500">*</span>
              </label>
              <input type="text" id="title" th:field="*{title}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 개인정보 수집·이용 동의서" required />
              <div th:if="${#fields.hasErrors('title')}" class="mt-1 text-sm text-red-600" th:errors="*{title}">제목 오류</div>
            </div>

            <!--/* Description Field */-->
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-2">템플릿 설명</label>
              <textarea id="description" th:field="*{description}" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="템플릿에 대한 설명을 간략히 입력해주세요"></textarea>
              <div th:if="${#fields.hasErrors('description')}" class="mt-1 text-sm text-red-600" th:errors="*{description}">설명 오류</div>
            </div>

            <!--/* Content Field with Rich Text Editor */-->
            <div>
              <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                동의서 내용
                <span class="text-red-500">*</span>
              </label>
              <div class="border border-gray-300 rounded-lg">
                <!--/* Toolbar */-->
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-300 flex flex-wrap items-center gap-2">
                  <button type="button" onclick="formatText('bold')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="굵게">
                    <i class="fas fa-bold"></i>
                  </button>
                  <button type="button" onclick="formatText('italic')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="기울임">
                    <i class="fas fa-italic"></i>
                  </button>
                  <button type="button" onclick="formatText('underline')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="밑줄">
                    <i class="fas fa-underline"></i>
                  </button>
                  <div class="w-px h-6 bg-gray-300"></div>
                  <button type="button" onclick="formatText('justifyLeft')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="왼쪽 정렬">
                    <i class="fas fa-align-left"></i>
                  </button>
                  <button type="button" onclick="formatText('justifyCenter')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="가운데 정렬">
                    <i class="fas fa-align-center"></i>
                  </button>
                  <button type="button" onclick="formatText('justifyRight')" class="px-3 py-1 text-gray-700 hover:bg-gray-200 rounded" title="오른쪽 정렬">
                    <i class="fas fa-align-right"></i>
                  </button>
                  <div class="w-px h-6 bg-gray-300"></div>
                  <button type="button" onclick="insertVariable('apartName')" class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-sm">{아파트명}</button>
                  <!--/* 사용자 입력 필드로 대체되므로 주석 처리
                  <button type="button" onclick="insertVariable('dong')" class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-sm">{동}</button>
                  <button type="button" onclick="insertVariable('ho')" class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-sm">{호}</button>
                  <button type="button" onclick="insertVariable('name')" class="px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-sm">{이름}</button>
                  */-->
                  <div class="w-px h-6 bg-gray-300"></div>
                  <button type="button" onclick="insertRadioGroup()" class="px-3 py-1 bg-green-100 text-green-700 hover:bg-green-200 rounded text-sm" title="라디오 버튼 추가">
                    <i class="fas fa-dot-circle mr-1"></i>선택
                  </button>
                  <button type="button" onclick="insertCheckbox()" class="px-3 py-1 bg-green-100 text-green-700 hover:bg-green-200 rounded text-sm" title="체크박스 추가">
                    <i class="fas fa-check-square mr-1"></i>체크
                  </button>
                </div>

                <!--/* Content Editor */-->
                <div id="contentEditor" contenteditable="true" class="min-h-[400px] p-4 focus:outline-none" th:utext="${template.content}" oninput="updateContent()"></div>
                <textarea id="content" th:field="*{content}" class="hidden" required></textarea>
              </div>
              <div th:if="${#fields.hasErrors('content')}" class="mt-1 text-sm text-red-600" th:errors="*{content}">내용 오류</div>
              <p class="mt-2 text-sm text-gray-500">변수를 클릭하여 동의서에 동적으로 표시될 정보를 삽입할 수 있습니다.</p>
            </div>

            <!--/* Assigned Apartments (only for edit mode) */-->
            <div th:if="${templateId != null}" class="border-t pt-6">
              <label class="block text-sm font-medium text-gray-700 mb-4">할당된 아파트</label>
              <div class="space-y-2">
                <div th:each="apart : ${aparts}" class="flex items-center">
                  <input type="checkbox" th:id="'apart_' + ${apart.id}" th:name="apartIds" th:value="${apart.id}" th:checked="${assignedApartIds != null and assignedApartIds.contains(apart.id)}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                  <label th:for="'apart_' + ${apart.id}" class="ml-2 text-sm text-gray-700">
                    <span th:text="${apart.aptName}">아파트명</span>
                    <span class="text-gray-500" th:text="'(' + ${apart.aptCode} + ')'">코드</span>
                  </label>
                </div>
              </div>
            </div>

            <!--/* Active Status */-->
            <div class="flex items-center">
              <input type="checkbox" id="active" th:field="*{active}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
              <label for="active" class="ml-2 text-sm text-gray-700">활성화</label>
            </div>

            <!--/* Form Actions */-->
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <a href="/admin/templates" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">취소</a>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-save mr-2"></i>
                <span th:text="${templateId != null ? '수정' : '생성'}">저장</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--/* Page-specific scripts */-->
    <th:block layout:fragment="script">
      <script>
        // Initialize content on page load
        document.addEventListener("DOMContentLoaded", function () {
          updateContent();
        });

        // Format text in the editor
        function formatText(command) {
          document.execCommand(command, false, null);
          updateContent();
        }

        // Insert variable placeholders
        function insertVariable(variable) {
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const span = document.createElement("span");
          span.className = "inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded mx-1";
          span.contentEditable = "false";
          span.textContent = "{" + variable + "}";
          range.insertNode(span);
          updateContent();
        }

        // Insert radio button group
        function insertRadioGroup() {
          const groupName = prompt("라디오 그룹 이름을 입력하세요 (예: agreement):");
          if (!groupName) return;

          const options = prompt("옵션들을 쉼표로 구분하여 입력하세요 (예: 동의,비동의):");
          if (!options) return;

          const optionArray = options.split(',').map(opt => opt.trim());
          const editor = document.getElementById("contentEditor");

          // Focus editor and get selection
          editor.focus();
          const selection = window.getSelection();

          // If no selection, create one at the end
          if (!selection.rangeCount) {
            const range = document.createRange();
            range.selectNodeContents(editor);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }

          const range = selection.getRangeAt(0);

          const container = document.createElement("div");
          container.className = "radio-group my-2 p-2 bg-gray-50 rounded border border-gray-200";
          container.setAttribute("data-group-name", groupName);
          container.contentEditable = "false";

          optionArray.forEach((option, index) => {
            const label = document.createElement("label");
            label.className = "inline-flex items-center mr-4";
            label.innerHTML = `
              <input type="radio" name="${groupName}" value="${option}"
                     class="form-radio text-blue-600" ${index === 0 ? 'checked' : ''}>
              <span class="ml-2">${option}</span>
            `;
            container.appendChild(label);
          });

          // Ensure we're inserting in the editor
          if (editor.contains(range.commonAncestorContainer)) {
            range.insertNode(container);
          } else {
            editor.appendChild(container);
          }

          // Add editable paragraph after the element
          const editableSpace = document.createElement("p");
          editableSpace.innerHTML = "<br>";
          container.parentNode.insertBefore(editableSpace, container.nextSibling);

          // Move cursor to the new editable space
          const newRange = document.createRange();
          newRange.selectNodeContents(editableSpace);
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);

          updateContent();
        }

        // Insert checkbox
        function insertCheckbox() {
          const checkboxName = prompt("체크박스 이름을 입력하세요 (예: terms):");
          if (!checkboxName) return;

          const labelText = prompt("체크박스 레이블을 입력하세요 (예: 개인정보 수집 동의):");
          if (!labelText) return;

          const editor = document.getElementById("contentEditor");

          // Focus editor and get selection
          editor.focus();
          const selection = window.getSelection();

          // If no selection, create one at the end
          if (!selection.rangeCount) {
            const range = document.createRange();
            range.selectNodeContents(editor);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }

          const range = selection.getRangeAt(0);

          const container = document.createElement("div");
          container.className = "checkbox-item my-2 p-2 bg-gray-50 rounded border border-gray-200";
          container.contentEditable = "false";

          const label = document.createElement("label");
          label.className = "inline-flex items-center";
          label.innerHTML = `
            <input type="checkbox" name="${checkboxName}" value="true"
                   class="form-checkbox text-blue-600">
            <span class="ml-2">${labelText}</span>
          `;

          container.appendChild(label);

          // Ensure we're inserting in the editor
          if (editor.contains(range.commonAncestorContainer)) {
            range.insertNode(container);
          } else {
            editor.appendChild(container);
          }

          // Add editable paragraph after the element
          const editableSpace = document.createElement("p");
          editableSpace.innerHTML = "<br>";
          container.parentNode.insertBefore(editableSpace, container.nextSibling);

          // Move cursor to the new editable space
          const newRange = document.createRange();
          newRange.selectNodeContents(editableSpace);
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);

          updateContent();
        }

        // Update hidden textarea with editor content
        function updateContent() {
          const editor = document.getElementById("contentEditor");
          const textarea = document.getElementById("content");
          textarea.value = editor.innerHTML;
        }

        // Handle form submission
        document.querySelector("form").addEventListener("submit", function (e) {
          updateContent();

          // Handle apartment assignments for edit mode
          if (document.querySelector('input[name="apartIds"]')) {
            const checkedAparts = Array.from(document.querySelectorAll('input[name="apartIds"]:checked')).map((cb) => cb.value);

            // Add hidden inputs for apartment assignments
            checkedAparts.forEach((apartId) => {
              const input = document.createElement("input");
              input.type = "hidden";
              input.name = "assignedApartIds";
              input.value = apartId;
              this.appendChild(input);
            });
          }
        });

        // Prevent default formatting on paste
        document.getElementById("contentEditor").addEventListener("paste", function (e) {
          e.preventDefault();
          const text = e.clipboardData.getData("text/plain");
          document.execCommand("insertText", false, text);
          updateContent();
        });
      </script>
    </th:block>
  </body>
</html>
